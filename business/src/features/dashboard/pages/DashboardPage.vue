<template>
  <ion-page>
    <AppHeader>
      <template #actions>
        <ion-button @click="handleLogout">
          <ion-icon slot="icon-only" :icon="logOutOutline" />
        </ion-button>
      </template>
    </AppHeader>

    <ion-content class="ion-padding">
      <PageNavigation page-title="–ì–ª–∞–≤–Ω–∞—è" :show-back-button="false" />
      <div class="dashboard-container">
        <!-- –°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ -->
        <ion-card>
          <ion-card-content>
            <div class="status-toggle-container">
              <label for="status-switch" class="status-label">
                –í–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–°–≤–æ–±–æ–¥–Ω—ã"
              </label>

              <Switch
                id="status-switch"
                v-model="isAvailable"
                :disabled="statusStore.loading"
                :style="{
                  position: 'relative',
                  display: 'inline-flex',
                  alignItems: 'center',
                  height: '31px',
                  width: '51px',
                  flexShrink: 0,
                  cursor: statusStore.loading ? 'not-allowed' : 'pointer',
                  borderRadius: '9999px',
                  padding: '2px',
                  transition: 'all 0.2s ease-in-out',
                  boxShadow: 'inset 0 1px 3px rgba(0, 0, 0, 0.15)',
                  backgroundColor: isAvailable ? '#98EA14' : '#e5e7eb',
                  border: isAvailable ? '1px solid #8bd612' : '1px solid #d1d5db',
                  opacity: statusStore.loading ? 0.5 : 1
                }"
                @update:modelValue="handleStatusToggle"
              >
                <span class="sr-only">–í–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–°–≤–æ–±–æ–¥–Ω—ã"</span>
                <span
                  :style="{
                    pointerEvents: 'none',
                    display: 'inline-block',
                    height: '27px',
                    width: '27px',
                    borderRadius: '9999px',
                    backgroundColor: 'white',
                    boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(0, 0, 0, 0.1)',
                    transition: 'transform 0.2s ease-in-out',
                    transform: isAvailable ? 'translateX(20px)' : 'translateX(0)'
                  }"
                />
              </Switch>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>

              <ion-item button detail @click="router.push('/bookings')">
                <ion-icon slot="start" :icon="calendarOutline" color="primary" />
                <ion-label>
                  <h2>–û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏</h2>
                  <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏</p>
                </ion-label>
              </ion-item>

              <ion-item button detail @click="router.push('/services')">
                <ion-icon slot="start" :icon="pricetagOutline" color="primary" />
                <ion-label>
                  <h2>–£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã</h2>
                  <p>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–π—Å</p>
                </ion-label>
              </ion-item>

              <ion-item button detail @click="router.push('/profile')">
                <ion-icon slot="start" :icon="personOutline" color="primary" />
                <ion-label>
                  <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
                  <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∏–∑–Ω–µ—Å–∞</p>
                </ion-label>
              </ion-item>

              <ion-item button detail @click="router.push('/business-hours')">
                <ion-icon slot="start" :icon="timeOutline" color="primary" />
                <ion-label>
                  <h2>–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã</h2>
                  <p>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
        <ion-card color="light">
          <ion-card-content>
            <p class="ion-text-center">
              üöß –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ.
            </p>
          </ion-card-content>
        </ion-card>
      </div>
    </ion-content>
  </ion-page>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import {
  IonPage,
  IonContent,
  IonCard,
  IonCardContent,
  IonList,
  IonItem,
  IonLabel,
  IonIcon,
  IonButton,
  toastController,
} from '@ionic/vue'
import {
  logOutOutline,
  calendarOutline,
  pricetagOutline,
  personOutline,
  timeOutline,
} from 'ionicons/icons'
import { Switch } from '@headlessui/vue'
import { useAuthStore } from '@/features/auth/stores/authStore'
import { useStatusStore } from '@/features/business-status/stores/statusStore'
import AppHeader from '@/shared/components/AppHeader.vue'
import PageNavigation from '@/shared/components/PageNavigation.vue'

const router = useRouter()
const authStore = useAuthStore()
const statusStore = useStatusStore()

const isAvailable = ref(false)

// Load current status on mount
onMounted(async () => {
  await statusStore.fetchCurrentStatus()
  isAvailable.value = statusStore.status === 'available'
})

// Handle status toggle
async function handleStatusToggle(value: boolean) {
  const result = await statusStore.updateStatus({
    status: value ? 'available' : 'busy',
    estimated_wait_minutes: 0,
  })

  if (result.success) {
    const toast = await toastController.create({
      message: value
        ? '–°—Ç–∞—Ç—É—Å "–°–≤–æ–±–æ–¥–Ω—ã" –≤–∫–ª—é—á–µ–Ω - –∫–ª–∏–µ–Ω—Ç—ã —É–≤–∏–¥—è—Ç –∑–µ–ª–µ–Ω—ã–π –º–∞—è—á–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ'
        : '–°—Ç–∞—Ç—É—Å "–°–≤–æ–±–æ–¥–Ω—ã" –≤—ã–∫–ª—é—á–µ–Ω',
      duration: 2500,
      color: value ? 'success' : 'medium',
      position: 'top',
    })
    await toast.present()
  } else {
    // Revert toggle on error
    isAvailable.value = !value
    const toast = await toastController.create({
      message: result.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞',
      duration: 3000,
      color: 'danger',
      position: 'top',
    })
    await toast.present()
  }
}

// Actions
async function handleLogout() {
  authStore.logout()
  await router.push('/login')
}
</script>

<style scoped>
.dashboard-container {
  max-width: 800px;
  margin: 0 auto;
}

ion-card {
  margin-bottom: 1rem;
  border-radius: 12px;
  overflow: hidden;
}

/* Status Toggle Container */
.status-toggle-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  padding: 4px 0;
}

.status-label {
  font-size: 1rem;
  font-weight: 500;
  color: var(--ion-color-dark);
  cursor: pointer;
  user-select: none;
}

/* iOS-style Toggle Switch */
.status-switch {
  position: relative;
  display: inline-flex;
  align-items: center;
  height: 31px;
  width: 51px;
  flex-shrink: 0;
  cursor: pointer;
  border-radius: 9999px;
  padding: 2px;
  transition: all 0.2s ease-in-out;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15);
}

/* Switch ON state - –∑–µ–ª–µ–Ω—ã–π */
.status-switch.switch-on {
  background-color: #98EA14;
  border: 1px solid #8bd612;
}

/* Switch OFF state - —Å–µ—Ä—ã–π */
.status-switch.switch-off {
  background-color: #e5e7eb;
  border: 1px solid #d1d5db;
}

.status-switch:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.status-switch:focus {
  outline: 2px solid #27126A;
  outline-offset: 2px;
}

.switch-thumb {
  pointer-events: none;
  display: inline-block;
  height: 27px;
  width: 27px;
  border-radius: 9999px;
  background-color: white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease-in-out;
}

/* Thumb positions */
.switch-thumb.thumb-off {
  transform: translateX(0);
}

.switch-thumb.thumb-on {
  transform: translateX(20px);
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}
</style>
